name: Release Image
run-name: ${{ github.event.inputs.tag }}, setLatest ${{ github.event.inputs.setLatest }}

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Image Version'
        required: true
      setLatest:
        description: 'Set Latest Tag'
        type: boolean
        required: true

jobs:

  build:
    name: build
    runs-on: ubuntu-latest
    steps:
      - name: Set up Docker
        uses: crazy-max/ghaction-setup-docker@v3
        with:
          daemon-config: |
            {
              "debug": true,
              "features": {
                "containerd-snapshotter": true
              }
            }            

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

    #  - name: Login to Docker Hub
    #    uses: docker/login-action@v3
    #    with:
    #      username: ${{ vars.DOCKERHUB_USERNAME }}
    #      password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push dockware/flex:${{ github.event.inputs.version }}
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64,linux/arm64
          push: false
          tags: dockware/flex:${{ github.event.inputs.version }}
          context: "{{defaultContext}}:src"
          build-args: |
            IMAGE_VERSION=${{ github.event.inputs.version }}

  on-push:
    name: Release Image
    runs-on: ubuntu-latest
    steps:

      - name: Clone Code
        uses: actions/checkout@v4


      - name: Release, Shopware ${{ github.event.inputs.swVersion }}
        uses: ./.github/actions/circleci
        with:
          VERSION: ${{ github.event.inputs.version }}
          SET_LATEST: ${{ github.event.inputs.setLatest }}
          # -------------------------------------------
          CIRCLECI_KEY: ${{ secrets.CIRCLE_CI_TOKEN }}